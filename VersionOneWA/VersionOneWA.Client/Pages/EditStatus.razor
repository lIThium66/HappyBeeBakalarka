@page "/edit-status"
@page "/edit-status/{id:int}"
@using System.Security.Claims
@inject IStatusServices StatusServices
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveAuto

@if (Id == null)
{
    <h2>Create Status</h2>
}
else
{
    <h2>Edit @status.Name</h2>
}

<h3>Track Your Hive’s Progress</h3>
<h5>Statuses help keep your colony on the right path. Stay informed, stay effective.</h5>

<div class="form-container">
    <EditForm EditContext="editContext" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit" FormName="EditStatus">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label>Name</label>
            <InputText @bind-Value="status.Name" />

            <label>Report</label>
            <textarea class="desc-text" @bind="status.Report"></textarea>

            <label>Created At</label>
            <InputDate @bind-Value="status.CreatedAt" />

        </div>

        <br />
        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">Submit</button>
        <ValidationSummary />
    </EditForm>
</div>

@code {
    [Parameter] public int? Id { get; set; }

    private EditContext? editContext;
    private bool isSubmitting;
    private string? currentUserId;
    private Status status = new Status
        {
            Name = string.Empty,
            Report = string.Empty,
            CreatedAt = DateTime.Now,
            doneTreatment = false,
            suppliedWater = false,
            suppliedSugar = false
        };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity == null || !user.Identity.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim != null)
        {
            currentUserId = userIdClaim.Value;
        }

        if (string.IsNullOrEmpty(currentUserId))
        {
            throw new Exception("User ID is null! Authentication might not be properly configured.");
        }

        editContext = new EditContext(status);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id == null)
        {
            status = new Status
                {
                    Name = string.Empty,
                    Report = string.Empty,
                    CreatedAt = DateTime.Now,
                    doneTreatment = false,
                    suppliedWater = false,
                    suppliedSugar = false
                };
        }
        else
        {
            var existingStatus = await StatusServices.GetStatusById((int)Id);
            if (existingStatus != null)
            {
                status = existingStatus;
            }
            else
            {
                status = new Status();
            }
        }

        editContext = new EditContext(status);
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        if (isSubmitting)
        {
            return;
        }

        isSubmitting = true;

        try
        {
            if (Id == null)
            {
                if (string.IsNullOrEmpty(currentUserId))
                {
                    throw new Exception("UserID is null. Are you sure user is authenticated?");
                }

                status.UserId = currentUserId;
                Console.WriteLine("Creating status: " + status.Name + ", UserId: " + status.UserId);
                await StatusServices.AddStatus(status);
            }
            else
            {
                Console.WriteLine("Editing status: " + status.Name + ", Id: " + status.Id);
                await StatusServices.EditStatus((int)status.Id, status);
            }

            NavigationManager.NavigateTo("/report");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error saving status: " + ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleInvalidSubmit()
    {
        Console.WriteLine("Form submission failed due to invalid data.");
    }
}
